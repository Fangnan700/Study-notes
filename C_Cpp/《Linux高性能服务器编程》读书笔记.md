# 第1章 TCP/IP协议族

## 1.1 TCP/IP协议族体系结构以及主要协议

TCP/IP协议族是一个分层、多协议的通信体系。

TCP/IP协议族是一个四层协议系统，自底而上分别是：

- 数据链路层
- 网络层
- 传输层
- 应用层

![image-20221103193012772](https://yvling-typora-image-1257337367.cos.ap-nanjing.myqcloud.com/typora/image-20221103193012772.png)

### 1.1.1 数据链路层

数据链路层实现了网卡接口的网络驱动程序，以处理数据在物理媒介（比如以太网、令牌环等）上的传输，为上层协议提供一个统一的接口。

**数据链路层两个常用的协议**

- ARP(Address Resolve Protocol，地址解析协议）
- RARP(Reverse Address Resolve Protocol，逆地址解析协议)

这两个协议实现了IP地址和机器物理地址（通常是MAC地址）之间的相互转换。



### 1.1.2 网络层

网络层实现数据包的选路和转发。

WAN（广域网）通过多级路由器连接主机和LAN（局域网），网络层的作用就是选择合适的中间节点（路由器）来确定某两台主机的通信路径。

网络层的核心是IP协议，IP协议根据数据包的目的IP地址来决定如何投递它——逐跳法。

网络层的另一重要协议是ICMP协议，它是IP协议的补充。



### 1.1.3 传输层

传输层为两台主机上的应用程序提供端到端的通信。这与网络层的逐跳法不同，传输层只关心通信的起始端和目的端，而不在乎数据包的中转过程。

传输层和网络层的区别：

![image-20221103204142101](https://yvling-typora-image-1257337367.cos.ap-nanjing.myqcloud.com/typora/image-20221103204142101.png)

传输层协议主要有三个：

- TCP协议
- UDP协议
- SCTP协议



**TCP协议**

TCP（传输控制协议）为应用层提供可靠的、面向连接的和基于流的服务。在发送数据前，通信双方必须在彼此间建立一条连接。所谓的“连接”，其实是客户端和服务器的内存里保存的一份关于对方的信息，如ip地址、端口号等。



**“三次握手”**

![image-20221104081543161](https://yvling-typora-image-1257337367.cos.ap-nanjing.myqcloud.com/typora/image-20221104081543161.png)

TCP协议建立连接的过程：

1. TCP服务器进程先创建传输控制块TCB，准备接受客户进程的连接请求，此时服务器进入LISTEN（监听）状态
2. TCP客户进程创建传输控制块TCB，然后向服务器发出连接请求报文，这是报文首部中的同部位SYN=1，同时选择一个初始序列号 seq=x ；此时，TCP客户端进程进入了 SYN-SENT（同步已发送状态）状态
3. TCP服务器收到请求报文后，如果同意连接，则发出确认报文。确认报文中应该 ACK=1，SYN=1，确认号是ack=x+1，同时也要为自己初始化一个序列号 seq=y，此时，TCP服务器进程进入了SYN-RCVD（同步收到）状态
4. TCP客户进程收到确认后，还要向服务器给出确认。确认报文的ACK=1，ack=y+1，自己的序列号seq=x+1，此时，TCP连接建立，客户端进入ESTABLISHED（已建立连接）状态
5. 当服务器收到客户端的确认后也进入ESTABLISHED状态，此后双方就可以开始通信了



**“四次挥手”**

![image-20221104081930980](https://yvling-typora-image-1257337367.cos.ap-nanjing.myqcloud.com/typora/image-20221104081930980.png)

1. 客户端进程发出连接释放报文，并且停止发送数据。释放数据报文首部，FIN=1，其序列号为seq=u（等于前面已经传送过来的数据的最后一个字节的序号加1），此时，客户端进入FIN-WAIT-1（终止等待1）状态
2. 服务器收到连接释放报文，发出确认报文，ACK=1，ack=u+1，并且带上自己的序列号seq=v，此时，服务端就进入了CLOSE-WAIT（关闭等待）状态
3. 客户端收到服务器的确认请求后，此时，客户端就进入FIN-WAIT-2（终止等待2）状态，等待服务器发送连接释放报文
4. 服务器将最后的数据发送完毕后，就向客户端发送连接释放报文，FIN=1，ack=u+1，服务器就进入了LAST-ACK（最后确认）状态，等待客户端的确认
5. 客户端收到服务器的连接释放报文后，必须发出确认，ACK=1，ack=w+1，而自己的序列号是seq=u+1，此时，客户端就进入了TIME-WAIT（时间等待）状态
6. 服务器只要收到了客户端发出的确认，立即进入CLOSED状态。同样，撤销TCB后，就结束了这次的TCP连接



**UDP协议**

UDP协议与TCP协议完全相反，它为应用层提供不可靠、无连接和基于数据报的服务。

UDP协议是无连接的，通信双方不保持一个长久的联系，应用程序每次发送数据都要明确指定接收端的地址。

每个UDP数据报都有一个长度，接收端必须以该长度为最小单位将其所有内容一次性读出，否则数据将被截断。



### 1.1.4 应用层

应用层负责处理应用程序的逻辑，比如文件传输、名称查询和网络管理等。

由于数据链路层、网络层和传输层需要处理通信的细节，需要极高的可靠性，因此这三层均在内核空间实现；而应用层需要处理的应用程序逻辑较为复杂和庞大，所以应用层在用户空间中实现。



**应用层的常见协议**

- telnet：telnet协议是一种远程登录协议
- OSPF：OSPF协议是一种动态路由更新协议，用于路由器之间的通信
- DNS：DNS协议提供机器域名到IP地址的转换

























